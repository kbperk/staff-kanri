<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KB PARK ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</title>
    <style>
        body { font-family: sans-serif; background: #f0fff4; color: #333; padding: 20px; padding-bottom: 100px; }
        .container { max-width: 800px; margin: 0 auto; display: none; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 6px solid #ccc; }
        .card.active { border-left-color: #32D74B; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }
        .side-box { padding: 15px; border-radius: 8px; background: #f9f9f9; border: 1px solid #eee; }
        .side-box.front { border-top: 4px solid #3498db; }
        .side-box.back { border-top: 4px solid #e74c3c; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        textarea { resize: vertical; }
        .btn-fixed { position: fixed; bottom: 30px; right: 30px; background: #32D74B; color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; transition: transform 0.2s; }
        .btn-fixed:hover { transform: scale(1.05); }
        .btn-fixed:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        #login-screen { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 10px; text-align: center; }
        #status-toast { position: fixed; bottom: 90px; right: 30px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-weight: bold; display: none; z-index: 999; }
    </style>
</head>
<body>
    <div id="login-screen">
        <h2>ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <input type="password" id="auth-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(0126)" style="text-align:center;">
        <button onclick="tryLogin()" style="margin-top:20px; padding:10px 20px; cursor:pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="login-msg" style="color:red; margin-top:10px;"></div>
    </div>

    <div id="main-interface" class="container">
        <h2 style="text-align: center; color: #32D74B;">ã‚¹ã‚¿ãƒƒãƒ•ç´¹ä»‹ æ›´æ–°ç”»é¢</h2>
        <form id="mainForm">
            <div id="form-container">èª­ã¿è¾¼ã¿ä¸­...</div>
            <button type="button" class="btn-fixed" id="submitBtn" onclick="uploadData()">ğŸ’¾ ä¸€æ‹¬æ›´æ–°ã™ã‚‹</button>
            <div id="status-toast"></div>
        </form>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxi-IvH67zp80Mp_whc2pltvRQR1aRvNeMAREGwvIbCz3gAp59M18SMtvC8tDEx6Ti9Kg/exec";

        async function callApi(action, payload = {}) {
            const pass = document.getElementById('auth-password').value;
            const res = await fetch(GAS_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action, auth: pass, payload })
            });
            const json = await res.json();
            if (!json.success) throw new Error(json.error);
            return json.data;
        }

        async function tryLogin() {
            const btn = document.querySelector('#login-screen button');
            const msg = document.getElementById('login-msg');
            msg.innerText = ""; btn.innerText = "èªè¨¼ä¸­..."; btn.disabled = true;

            try {
                const data = await callApi('getStaffData');
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-interface').style.display = 'block';
                createForm(data);
            } catch (err) { 
                msg.innerText = err.message; 
                btn.innerText = "ãƒ­ã‚°ã‚¤ãƒ³"; btn.disabled = false;
            }
        }

        function createForm(currentData) {
            const container = document.getElementById('form-container');
            container.innerHTML = ""; 

            for (let i = 1; i <= 10; i++) {
                const d = currentData.find(x => x.id === i) || { front: {}, back: {} };
                const f = d.front || {}; const b = d.back || {};
                
                const html = `
                  <div class="card ${d.name ? 'active' : ''}">
                    <h3>æ  ${i} ${d.name ? `(${d.name})` : '(æœªç™»éŒ²)'}</h3>
                    <label>ã‚¹ã‚¿ãƒƒãƒ•å</label>
                    <input type="text" name="name_${i}" value="${d.name || ''}" placeholder="åå‰ã‚’å…¥åŠ›ï¼ˆç©ºã«ã™ã‚‹ã¨å‰Šé™¤ï¼‰">
                    
                    <div class="grid-2" style="margin-top:15px;">
                        <div class="side-box front">
                            <h4 style="margin:0 0 10px; color:#3498db;">ã€è¡¨ã€‘ãƒã‚¸ãƒ¡ãƒ¢ãƒ¼ãƒ‰</h4>
                            <label>ç”»åƒ1</label><input type="file" accept="image/*" onchange="handleFile(this, 'front', ${i})">
                            <input type="hidden" name="file_front_${i}" id="file_front_${i}">
                            <label>è³ªå•1 ãƒ©ãƒ™ãƒ«</label><input type="text" name="f_q1_label_${i}" value="${f.q1_label || 'ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼'}">
                            <label>è³ªå•1 å›ç­”</label><textarea name="f_q1_val_${i}" rows="4" placeholder="æ”¹è¡Œã‚‚åæ˜ ã•ã‚Œã¾ã™">${f.q1_val || ''}</textarea>
                            <label>è³ªå•2 ãƒ©ãƒ™ãƒ«</label><input type="text" name="f_q2_label_${i}" value="${f.q2_label || 'è‡ªå·±ç´¹ä»‹'}">
                            <label>è³ªå•2 å›ç­”</label><textarea name="f_q2_val_${i}" rows="4">${f.q2_val || ''}</textarea>
                        </div>
                        <div class="side-box back">
                            <h4 style="margin:0 0 10px; color:#e74c3c;">ã€è£ã€‘ãŠãµã–ã‘ãƒ¢ãƒ¼ãƒ‰</h4>
                            <label>ç”»åƒ2</label><input type="file" accept="image/*" onchange="handleFile(this, 'back', ${i})">
                            <input type="hidden" name="file_back_${i}" id="file_back_${i}">
                            <label>è³ªå•1 ãƒ©ãƒ™ãƒ«</label><input type="text" name="b_q1_label_${i}" value="${b.q1_label || 'è£ã®é€šã‚Šå'}">
                            <label>è³ªå•1 å›ç­”</label><textarea name="b_q1_val_${i}" rows="4">${b.q1_val || ''}</textarea>
                            <label>è³ªå•2 ãƒ©ãƒ™ãƒ«</label><input type="text" name="b_q2_label_${i}" value="${b.q2_label || 'ãŠãµã–ã‘ã‚³ãƒ¡ãƒ³ãƒˆ'}">
                            <label>è³ªå•2 å›ç­”</label><textarea name="b_q2_val_${i}" rows="4">${b.q2_val || ''}</textarea>
                        </div>
                    </div>
                  </div>`;
                container.insertAdjacentHTML('beforeend', html);
            }
        }

        function handleFile(input, type, index) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => document.getElementById(`file_${type}_${index}`).value = e.target.result.split(',')[1];
                reader.readAsDataURL(file);
            } else {
                document.getElementById(`file_${type}_${index}`).value = "";
            }
        }

        async function uploadData() {
            if(!confirm("æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const btn = document.getElementById('submitBtn');
            const toast = document.getElementById('status-toast');
            
            btn.innerText = "â³ é€ä¿¡ä¸­..."; btn.disabled = true;
            toast.style.display = "none";
            
            const formData = {};
            document.querySelectorAll('#mainForm input, #mainForm textarea').forEach(inp => formData[inp.name] = inp.value);

            try {
                const resultMsg = await callApi('saveStaffData', formData);
                toast.innerText = "âœ… " + resultMsg;
                toast.style.color = "green";
            } catch(e) {
                toast.innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + e.message;
                toast.style.color = "red";
            }
            toast.style.display = "block";
            btn.innerText = "ğŸ’¾ ä¸€æ‹¬æ›´æ–°ã™ã‚‹"; btn.disabled = false;
            
            setTimeout(() => { toast.style.display = "none"; }, 5000);
        }
    </script>
</body>
</html>